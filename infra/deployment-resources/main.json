{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.28.1.47646",
      "templateHash": "15564239711167319716"
    }
  },
  "parameters": {
    "rgName": {
      "type": "string",
      "metadata": {
        "description": "The name of the resource group for all GitHub deployment resources"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "The location where all resources will be deployed to"
      }
    },
    "tags": {
      "type": "object",
      "metadata": {
        "description": "The tags that will be applied to all GitHub deployment resources"
      }
    },
    "uaiName": {
      "type": "string",
      "metadata": {
        "description": "The name of the user-assigned identity used for GitHub deployments"
      }
    },
    "githubOrganizationName": {
      "type": "string",
      "metadata": {
        "description": "The name of the GitHub Organization"
      }
    },
    "githubRepositoryName": {
      "type": "string",
      "metadata": {
        "description": "The name of the GitHub repository"
      }
    },
    "githubEnvironmentName": {
      "type": "string",
      "metadata": {
        "description": "The name of the GitHub environment"
      }
    }
  },
  "variables": {
    "defaultAudienceName": "api://AzureADTokenExchange",
    "githubIssuerUrl": "https://token.actions.githubusercontent.com",
    "subOwnerRoleId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2024-07-01",
      "name": "[parameters('rgName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]"
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(subscription().id, parameters('rgName'), 'github-uai')]",
      "properties": {
        "principalId": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('rgName')), 'Microsoft.Resources/deployments', 'github-uai'), '2022-09-01').outputs.prinicpalId.value]",
        "roleDefinitionId": "[variables('subOwnerRoleId')]"
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('rgName')), 'Microsoft.Resources/deployments', 'github-uai')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('rgName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "github-uai",
      "resourceGroup": "[parameters('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('uaiName')]"
          },
          "location": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('rgName')), '2024-07-01', 'full').location]"
          },
          "tags": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('rgName')), '2024-07-01', 'full').tags]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.28.1.47646",
              "templateHash": "6349310950086628442"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the user-assigned identity"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The region that the user-assigned identity will be deployed to"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags that will be applied to the user-assigned identity"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "uaiName": {
              "type": "string",
              "metadata": {
                "description": "The name of the deployed user-assigned identity"
              },
              "value": "[parameters('name')]"
            },
            "prinicpalId": {
              "type": "string",
              "metadata": {
                "description": "The Principal Id of the deployed user-assigned identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('rgName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "github-fc-env",
      "resourceGroup": "[parameters('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-{1}-{2}', parameters('githubOrganizationName'), parameters('githubRepositoryName'), parameters('githubEnvironmentName'))]"
          },
          "audiences": {
            "value": [
              "[variables('defaultAudienceName')]"
            ]
          },
          "issuer": {
            "value": "[variables('githubIssuerUrl')]"
          },
          "subject": {
            "value": "[format('repo:{0}/{1}-{2}', parameters('githubOrganizationName'), parameters('githubRepositoryName'), parameters('githubEnvironmentName'))]"
          },
          "uaiName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('rgName')), 'Microsoft.Resources/deployments', 'github-uai'), '2022-09-01').outputs.uaiName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.28.1.47646",
              "templateHash": "3867015505216431576"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The resource name of the federated credential for the user-assigned identity"
              }
            },
            "uaiName": {
              "type": "string",
              "metadata": {
                "description": "The name of the user-assigned identity that the federated credential will be applied to"
              }
            },
            "audiences": {
              "type": "array",
              "metadata": {
                "description": "The list of audiences that can appear in the issued token"
              }
            },
            "issuer": {
              "type": "string",
              "metadata": {
                "description": "The URL of the issuer to be trusted"
              }
            },
            "subject": {
              "type": "string",
              "metadata": {
                "description": "The subject identifier of the external identity"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities/federatedIdentityCredentials",
              "apiVersion": "2023-01-31",
              "name": "[format('{0}/{1}', parameters('uaiName'), parameters('name'))]",
              "properties": {
                "audiences": "[parameters('audiences')]",
                "issuer": "[parameters('issuer')]",
                "subject": "[parameters('subject')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('rgName')), 'Microsoft.Resources/deployments', 'github-uai')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('rgName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "github-fc-pr",
      "resourceGroup": "[parameters('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-{1}-pr', parameters('githubOrganizationName'), parameters('githubRepositoryName'))]"
          },
          "audiences": {
            "value": [
              "[variables('defaultAudienceName')]"
            ]
          },
          "issuer": {
            "value": "[variables('githubIssuerUrl')]"
          },
          "subject": {
            "value": "[format('repo:{0}/{1}:pull_request', parameters('githubOrganizationName'), parameters('githubRepositoryName'))]"
          },
          "uaiName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('rgName')), 'Microsoft.Resources/deployments', 'github-uai'), '2022-09-01').outputs.uaiName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.28.1.47646",
              "templateHash": "3867015505216431576"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The resource name of the federated credential for the user-assigned identity"
              }
            },
            "uaiName": {
              "type": "string",
              "metadata": {
                "description": "The name of the user-assigned identity that the federated credential will be applied to"
              }
            },
            "audiences": {
              "type": "array",
              "metadata": {
                "description": "The list of audiences that can appear in the issued token"
              }
            },
            "issuer": {
              "type": "string",
              "metadata": {
                "description": "The URL of the issuer to be trusted"
              }
            },
            "subject": {
              "type": "string",
              "metadata": {
                "description": "The subject identifier of the external identity"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities/federatedIdentityCredentials",
              "apiVersion": "2023-01-31",
              "name": "[format('{0}/{1}', parameters('uaiName'), parameters('name'))]",
              "properties": {
                "audiences": "[parameters('audiences')]",
                "issuer": "[parameters('issuer')]",
                "subject": "[parameters('subject')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('rgName')), 'Microsoft.Resources/deployments', 'github-uai')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('rgName'))]"
      ]
    }
  ]
}